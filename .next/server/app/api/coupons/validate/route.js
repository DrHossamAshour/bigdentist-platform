"use strict";(()=>{var e={};e.id=976,e.ids=[976],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54043:(e,t,o)=>{o.r(t),o.d(t,{headerHooks:()=>h,originalPathname:()=>f,patchFetch:()=>C,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>v});var r={};o.r(r),o.d(r,{POST:()=>c});var n=o(95419),i=o(69108),a=o(99678),u=o(78070),s=o(3214);async function c(e){try{let{code:t,amount:o,courseId:r,appliedCoupons:n=[]}=await e.json();if(!t||!o)return u.Z.json({error:"Coupon code and amount are required"},{status:400});let i=await s._.coupon.findUnique({where:{code:t.toUpperCase()}});if(!i)return u.Z.json({error:"Invalid coupon code"},{status:404});if(!i.isActive)return u.Z.json({error:"Coupon is inactive"},{status:400});if(i.validUntil&&new Date>i.validUntil)return u.Z.json({error:"Coupon has expired"},{status:400});if(i.usageLimit&&i.usedCount>=i.usageLimit)return u.Z.json({error:"Coupon usage limit reached"},{status:400});if(i.minAmount&&o<i.minAmount)return u.Z.json({error:`Minimum order amount of $${i.minAmount} required`},{status:400});if(!i.appliesToAllCourses&&r&&!(i.allowedCourseIds?.split(",").map(e=>e.trim())||[]).includes(r))return u.Z.json({error:"This coupon is not valid for this course"},{status:400});if(!i.canStackWithOtherCoupons&&n.length>0)return u.Z.json({error:"This coupon cannot be combined with other coupons"},{status:400});let a=0;"PERCENTAGE"===i.discountType?(a=o*i.discountValue/100,i.maxDiscount&&a>i.maxDiscount&&(a=i.maxDiscount)):"FIXED_AMOUNT"===i.discountType&&(a=i.discountValue);let c=Math.max(0,o-a);return u.Z.json({valid:!0,coupon:{id:i.id,code:i.code,description:i.description,discountType:i.discountType,discountValue:i.discountValue,canStackWithOtherCoupons:i.canStackWithOtherCoupons},discountAmount:Math.round(100*a)/100,finalAmount:Math.round(100*c)/100,originalAmount:o})}catch(e){return console.error("Error validating coupon:",e),u.Z.json({error:"Internal server error"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/coupons/validate/route",pathname:"/api/coupons/validate",filename:"route",bundlePath:"app/api/coupons/validate/route"},resolvedPagePath:"E:\\BigDentist Website\\app\\api\\coupons\\validate\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:m,headerHooks:h,staticGenerationBailout:v}=d,f="/api/coupons/validate/route";function C(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},3214:(e,t,o)=>{o.d(t,{_:()=>n});var r=o(53524);let n=globalThis.prisma??new r.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[1638,6206],()=>o(54043));module.exports=r})();